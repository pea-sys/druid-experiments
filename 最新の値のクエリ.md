# 最新の値のクエリ

他のデータベースで UPSERT によって処理される可能性のあるユースケースに対する Apache Druid の戦略について説明します。クエリ時に LATEST_BY 集計を使用するか、挿入時に数値ディメンションの「デルタ」を使用できます。

https://druid.apache.org/docs/latest/tutorials/tutorial-latest-by/

druid を起動

```
apache-druid-30.0.0> ./bin/start-druid
```

### Use LATEST_BY

LATEST_BY 関数を使用すると、次の種類のクエリでディメンションの最新の値を取得できます。

```sql
SELECT dimension,
       LATEST_BY(changed_dimension, updated_timestamp)
FROM my_table
GROUP BY 1
```

サンプルデータ挿入

```sql
REPLACE INTO "latest_by_tutorial1" OVERWRITE ALL
WITH "ext" AS (
  SELECT *
  FROM TABLE(
    EXTERN(
     '{"type":"inline","data":"{\"timestamp\":\"2024-01-01T01:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":10}\n{\"timestamp\":\"2024-01-01T01:05:00Z\",\"user_id\":\"funny_bunny1\", \"points\":30}\n{\"timestamp\": \"2024-01-01T02:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":35}\n{\"timestamp\":\"2024-01-01T02:00:00Z\",\"user_id\":\"silly_monkey2\", \"points\":30}\n{\"timestamp\":\"2024-01-01T02:05:00Z\",\"user_id\":\"silly_monkey2\", \"points\":55}\n{\"timestamp\":\"2024-01-01T03:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":40}"}',
     '{"type":"json"}'
    )
  ) EXTEND ("timestamp" VARCHAR, "user_id" VARCHAR, "points" BIGINT)
)
SELECT
  TIME_PARSE("timestamp") AS "__time",
  "user_id",
  "points"
FROM "ext"
PARTITIONED BY DAY
```

直近の値を`latest_by`で取得します

```sql
dsql> SELECT user_id,
     LATEST_BY("points", "__time") AS latest_points
FROM latest_by_tutorial1
GROUP BY 1;
┌───────────────┬───────────────┐
│ user_id       │ latest_points │
├───────────────┼───────────────┤
│ funny_bunny1  │            40 │
│ silly_monkey2 │            55 │
└───────────────┴───────────────┘
Retrieved 2 rows in 0.30s.
```

より細かい粒度の時間枠内で異なる時間に最新の値を追跡したい場合は、更新時間を記録するための追加のタイムスタンプが必要です。

サンプルデータ挿入

```sql
REPLACE INTO "latest_by_tutorial2" OVERWRITE ALL
WITH "ext" AS (
  SELECT *
  FROM TABLE(
    EXTERN(
     '{"type":"inline","data":"{\"timestamp\":\"2024-01-01T01:00:00Z\",\"updated_timestamp\":\"2024-01-01T01:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":10}\n{\"timestamp\":\"2024-01-01T01:05:00Z\",\"updated_timestamp\":\"2024-01-01T01:05:00Z\",\"user_id\":\"funny_bunny1\", \"points\":30}\n{\"timestamp\": \"2024-01-01T02:00:00Z\",\"updated_timestamp\":\"2024-01-01T02:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":35}\n{\"timestamp\":\"2024-01-01T02:00:00Z\",\"updated_timestamp\":\"2024-01-01T02:00:00Z\",\"user_id\":\"silly_monkey2\", \"points\":30}\n{\"timestamp\":\"2024-01-01T02:00:00Z\",\"updated_timestamp\":\"2024-01-01T02:05:00Z\",\"user_id\":\"silly_monkey2\", \"points\":55}\n{\"timestamp\":\"2024-01-01T03:00:00Z\",\"updated_timestamp\":\"2024-01-01T03:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":40}"}',
     '{"type":"json"}'
    )
  ) EXTEND ("timestamp" VARCHAR, "updated_timestamp" VARCHAR, "user_id" VARCHAR, "points" BIGINT)
)
SELECT
  TIME_PARSE("timestamp") AS "__time",
  "updated_timestamp",
  "user_id",
  "points"
FROM "ext"
PARTITIONED BY DAY
```

テーブル全体のデータは次の通り

```sql
dsql> select * from latest_by_tutorial2;
┌──────────────────────────┬──────────────────────┬───────────────┬────────┐
│ __time                   │ updated_timestamp    │ user_id       │ points │
├──────────────────────────┼──────────────────────┼───────────────┼────────┤
│ 2024-01-01T01:00:00.000Z │ 2024-01-01T01:00:00Z │ funny_bunny1  │     10 │
│ 2024-01-01T01:05:00.000Z │ 2024-01-01T01:05:00Z │ funny_bunny1  │     30 │
│ 2024-01-01T02:00:00.000Z │ 2024-01-01T02:00:00Z │ funny_bunny1  │     35 │
│ 2024-01-01T02:00:00.000Z │ 2024-01-01T02:00:00Z │ silly_monkey2 │     30 │
│ 2024-01-01T02:00:00.000Z │ 2024-01-01T02:05:00Z │ silly_monkey2 │     55 │
│ 2024-01-01T03:00:00.000Z │ 2024-01-01T03:00:00Z │ funny_bunny1  │     40 │
└──────────────────────────┴──────────────────────┴───────────────┴────────┘
Retrieved 6 rows in 0.04s.
```

`latest_by`で hour 事の最新値を取得します

```sql
dsql> SELECT FLOOR("__time" TO HOUR) AS "hour_time",
      "user_id",
       LATEST_BY("points", TIME_PARSE(updated_timestamp)) AS "latest_points_hour"
FROM latest_by_tutorial2
GROUP BY 1,2;
┌──────────────────────────┬───────────────┬────────────────────┐
│ hour_time                │ user_id       │ latest_points_hour │
├──────────────────────────┼───────────────┼────────────────────┤
│ 2024-01-01T01:00:00.000Z │ funny_bunny1  │                 30 │
│ 2024-01-01T02:00:00.000Z │ funny_bunny1  │                 35 │
│ 2024-01-01T02:00:00.000Z │ silly_monkey2 │                 55 │
│ 2024-01-01T03:00:00.000Z │ funny_bunny1  │                 40 │
└──────────────────────────┴───────────────┴────────────────────┘
Retrieved 4 rows in 0.25s.
```

`latest_by`は更新がデータの 1 ～ 5 パーセントを占める場合、クエリのパフォーマンスは良好になります。更新がデータの 50 パーセント以上を占める場合、クエリは遅くなります。
更新が多いテーブルで使用したい場合は REINDEX の使用が推奨されています。

### Use delta values and aggregation for updated values

イベントに最新の合計値を追加する代わりに、各イベントで値の変化を記録し、通常使用するアグリゲータを使用できます。

たとえば、一定期間内にユーザーが獲得または失ったポイントの数を記録する次のイベント テーブルを考えてみます。

```sql
REPLACE INTO "delta_tutorial" OVERWRITE ALL
WITH "ext" AS (
  SELECT *
  FROM TABLE(
    EXTERN(
     '{"type":"inline","data":"{\"timestamp\":\"2024-01-01T01:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":10}\n{\"timestamp\":\"2024-01-01T01:05:00Z\",\"user_id\":\"funny_bunny1\", \"points\":10}\n{\"timestamp\": \"2024-01-01T02:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":5}\n{\"timestamp\":\"2024-01-01T02:00:00Z\",\"user_id\":\"silly_monkey2\", \"points\":30}\n{\"timestamp\":\"2024-01-01T02:05:00Z\",\"user_id\":\"silly_monkey2\", \"points\":-5}\n{\"timestamp\":\"2024-01-01T03:00:00Z\",\"user_id\":\"funny_bunny1\", \"points\":10}"}',
     '{"type":"json"}'
    )
  ) EXTEND ("timestamp" VARCHAR, "user_id" VARCHAR, "points" BIGINT)
)
SELECT
  TIME_PARSE("timestamp") AS "__time",
  "user_id",
  "points" AS "delta"
FROM "ext"
PARTITIONED BY DAY
```

テーブル全体

```Sql
dsql> select * from delta_tutorial;
┌──────────────────────────┬───────────────┬───────┐
│ __time                   │ user_id       │ delta │
├──────────────────────────┼───────────────┼───────┤
│ 2024-01-01T01:00:00.000Z │ funny_bunny1  │    10 │
│ 2024-01-01T01:05:00.000Z │ funny_bunny1  │    10 │
│ 2024-01-01T02:00:00.000Z │ funny_bunny1  │     5 │
│ 2024-01-01T02:00:00.000Z │ silly_monkey2 │    30 │
│ 2024-01-01T02:05:00.000Z │ silly_monkey2 │    -5 │
│ 2024-01-01T03:00:00.000Z │ funny_bunny1  │    10 │
└──────────────────────────┴───────────────┴───────┘
Retrieved 6 rows in 0.06s.
```

2 番目の LATEST_BY の例と同じ 1 時間あたりのポイントを返します

```sql
dsql> SELECT FLOOR("__time" TO HOUR) as "hour_time",
       "user_id",
       SUM("delta") AS "latest_points_hour"
FROM "delta_tutorial"
GROUP BY 1,2;
┌──────────────────────────┬───────────────┬────────────────────┐
│ hour_time                │ user_id       │ latest_points_hour │
├──────────────────────────┼───────────────┼────────────────────┤
│ 2024-01-01T01:00:00.000Z │ funny_bunny1  │                 20 │
│ 2024-01-01T02:00:00.000Z │ funny_bunny1  │                  5 │
│ 2024-01-01T02:00:00.000Z │ silly_monkey2 │                 25 │
│ 2024-01-01T03:00:00.000Z │ funny_bunny1  │                 10 │
└──────────────────────────┴───────────────┴────────────────────┘
Retrieved 4 rows in 0.08s.
```
