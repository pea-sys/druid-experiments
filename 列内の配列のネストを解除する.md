# 列内の配列のネストを解除する

https://druid.apache.org/docs/latest/tutorials/tutorial-unnest-arrays

このチュートリアルでは、unnest データソースを使用して、配列に格納されたデータを持つ列をネスト解除する方法を説明します。

データ登録

```Sql
REPLACE INTO nested_data OVERWRITE ALL
SELECT
  TIME_PARSE("t") as __time,
  dim1,
  dim2,
  dim3,
  dim4,
  dim5,
  m1,
  m2
FROM TABLE(
    EXTERN(
    '{"type":"inline","data":"{\"t\":\"2000-01-01\",\"m1\":\"1.0\",\"m2\":\"1.0\",\"dim1\":\"\",\"dim2\":[\"a\"],\"dim3\":[\"a\",\"b\"],\"dim4\":[\"x\",\"y\"],\"dim5\":[\"a\",\"b\"]},\n{\"t\":\"2000-01-02\",\"m1\":\"2.0\",\"m2\":\"2.0\",\"dim1\":\"10.1\",\"dim2\":[],\"dim3\":[\"c\",\"d\"],\"dim4\":[\"e\",\"f\"],\"dim5\":[\"a\",\"b\",\"c\",\"d\"]},\n{\"t\":\"2001-01-03\",\"m1\":\"6.0\",\"m2\":\"6.0\",\"dim1\":\"abc\",\"dim2\":[\"a\"],\"dim3\":[\"k\",\"l\"]},\n{\"t\":\"2001-01-01\",\"m1\":\"4.0\",\"m2\":\"4.0\",\"dim1\":\"1\",\"dim2\":[\"a\"],\"dim3\":[\"g\",\"h\"]},\n{\"t\":\"2001-01-02\",\"m1\":\"5.0\",\"m2\":\"5.0\",\"dim1\":\"def\",\"dim2\":[\"abc\"],\"dim3\":[\"i\",\"j\"]},\n{\"t\":\"2001-01-03\",\"m1\":\"6.0\",\"m2\":\"6.0\",\"dim1\":\"abc\",\"dim2\":[\"a\"],\"dim3\":[\"k\",\"l\"]},\n{\"t\":\"2001-01-02\",\"m1\":\"5.0\",\"m2\":\"5.0\",\"dim1\":\"def\",\"dim2\":[\"abc\"],\"dim3\":[\"m\",\"n\"]}"}',
    '{"type":"json"}',
    '[{"name":"t","type":"string"},{"name":"dim1","type":"string"},{"name":"dim2","type":"string"},{"name":"dim3","type":"string"},{"name":"dim4","type":"string"},{"name":"dim5","type":"string"},{"name":"m1","type":"float"},{"name":"m2","type":"double"}]'
  )
)
PARTITIONED BY YEAR
```

データ確認

```sql
./bin/dsql
[sudo] masami のパスワード:
Welcome to dsql, the command-line client for Druid SQL.
Connected to [http://localhost:8082/].

Type "\h" for help.
dsql> SELECT * FROM nested_data;
┌──────────────────────────┬──────┬──────┬───────────┬───────────┬───────────────────┬─────┬─────┐
│ __time                   │ dim1 │ dim2 │ dim3      │ dim4      │ dim5              │ m1  │ m2  │
├──────────────────────────┼──────┼──────┼───────────┼───────────┼───────────────────┼─────┼─────┤
│ 2000-01-01T00:00:00.000Z │      │ a    │ ["a","b"] │ ["x","y"] │ ["a","b"]         │ 1.0 │ 1.0 │
│ 2000-01-02T00:00:00.000Z │ 10.1 │ NULL │ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ 2.0 │ 2.0 │
│ 2001-01-01T00:00:00.000Z │ 1    │ a    │ ["g","h"] │ NULL      │ NULL              │ 4.0 │ 4.0 │
│ 2001-01-02T00:00:00.000Z │ def  │ abc  │ ["i","j"] │ NULL      │ NULL              │ 5.0 │ 5.0 │
│ 2001-01-02T00:00:00.000Z │ def  │ abc  │ ["m","n"] │ NULL      │ NULL              │ 5.0 │ 5.0 │
│ 2001-01-03T00:00:00.000Z │ abc  │ a    │ ["k","l"] │ NULL      │ NULL              │ 6.0 │ 6.0 │
│ 2001-01-03T00:00:00.000Z │ abc  │ a    │ ["k","l"] │ NULL      │ NULL              │ 6.0 │ 6.0 │
└──────────────────────────┴──────┴──────┴───────────┴───────────┴───────────────────┴─────┴─────┘
Retrieved 7 rows in 0.06s.
```

列 dim3 を単一列としてネストを解除

```sql
dsql> SELECT d3 FROM "nested_data" CROSS JOIN UNNEST(MV_TO_ARRAY(dim3)) AS example_table(d3);
┌────┐
│ d3 │
├────┤
│ a  │
│ b  │
│ c  │
│ d  │
│ g  │
│ h  │
│ i  │
│ j  │
│ m  │
│ n  │
│ k  │
│ l  │
│ k  │
│ l  │
└────┘
Retrieved 14 rows in 0.30s.
```

ネストを解除して仮想列にすることができます

```sql
dsql> SELECT dim4,dim5,d45 FROM nested_data CROSS JOIN UNNEST(ARRAY_CONCAT(dim4,dim5)) AS example_table(d45);
┌───────────┬───────────────────┬─────┐
│ dim4      │ dim5              │ d45 │
├───────────┼───────────────────┼─────┤
│ ["x","y"] │ ["a","b"]         │ x   │
│ ["x","y"] │ ["a","b"]         │ y   │
│ ["x","y"] │ ["a","b"]         │ a   │
│ ["x","y"] │ ["a","b"]         │ b   │
│ ["e","f"] │ ["a","b","c","d"] │ e   │
│ ["e","f"] │ ["a","b","c","d"] │ f   │
│ ["e","f"] │ ["a","b","c","d"] │ a   │
│ ["e","f"] │ ["a","b","c","d"] │ b   │
│ ["e","f"] │ ["a","b","c","d"] │ c   │
│ ["e","f"] │ ["a","b","c","d"] │ d   │
└───────────┴───────────────────┴─────┘
Retrieved 10 rows in 0.14s.
```

複数の unnest

```sql
dsql> SELECT dim3,dim4,dim5,d3,d45 FROM "nested_data" CROSS JOIN UNNEST(MV_TO_ARRAY("dim3")) AS foo1(d3) CROSS JOIN UNNEST(ARRAY[dim4,dim5]) AS foo2(d45);
┌───────────┬───────────┬───────────────────┬────┬───────────┐
│ dim3      │ dim4      │ dim5              │ d3 │ d45       │
├───────────┼───────────┼───────────────────┼────┼───────────┤
│ ["a","b"] │ ["x","y"] │ ["a","b"]         │ a  │ ["x","a"] │
│ ["a","b"] │ ["x","y"] │ ["a","b"]         │ a  │ ["x","b"] │
│ ["a","b"] │ ["x","y"] │ ["a","b"]         │ a  │ ["y","a"] │
│ ["a","b"] │ ["x","y"] │ ["a","b"]         │ a  │ ["y","b"] │
│ ["a","b"] │ ["x","y"] │ ["a","b"]         │ b  │ ["x","a"] │
│ ["a","b"] │ ["x","y"] │ ["a","b"]         │ b  │ ["x","b"] │
│ ["a","b"] │ ["x","y"] │ ["a","b"]         │ b  │ ["y","a"] │
│ ["a","b"] │ ["x","y"] │ ["a","b"]         │ b  │ ["y","b"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ c  │ ["e","a"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ c  │ ["e","b"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ c  │ ["e","c"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ c  │ ["e","d"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ c  │ ["f","a"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ c  │ ["f","b"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ c  │ ["f","c"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ c  │ ["f","d"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ d  │ ["e","a"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ d  │ ["e","b"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ d  │ ["e","c"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ d  │ ["e","d"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ d  │ ["f","a"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ d  │ ["f","b"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ d  │ ["f","c"] │
│ ["c","d"] │ ["e","f"] │ ["a","b","c","d"] │ d  │ ["f","d"] │
│ ["g","h"] │ NULL      │ NULL              │ g  │ NULL      │
│ ["g","h"] │ NULL      │ NULL              │ g  │ NULL      │
│ ["g","h"] │ NULL      │ NULL              │ h  │ NULL      │
│ ["g","h"] │ NULL      │ NULL              │ h  │ NULL      │
│ ["i","j"] │ NULL      │ NULL              │ i  │ NULL      │
│ ["i","j"] │ NULL      │ NULL              │ i  │ NULL      │
│ ["i","j"] │ NULL      │ NULL              │ j  │ NULL      │
│ ["i","j"] │ NULL      │ NULL              │ j  │ NULL      │
│ ["m","n"] │ NULL      │ NULL              │ m  │ NULL      │
│ ["m","n"] │ NULL      │ NULL              │ m  │ NULL      │
│ ["m","n"] │ NULL      │ NULL              │ n  │ NULL      │
│ ["m","n"] │ NULL      │ NULL              │ n  │ NULL      │
│ ["k","l"] │ NULL      │ NULL              │ k  │ NULL      │
│ ["k","l"] │ NULL      │ NULL              │ k  │ NULL      │
│ ["k","l"] │ NULL      │ NULL              │ l  │ NULL      │
│ ["k","l"] │ NULL      │ NULL              │ l  │ NULL      │
│ ["k","l"] │ NULL      │ NULL              │ k  │ NULL      │
│ ["k","l"] │ NULL      │ NULL              │ k  │ NULL      │
│ ["k","l"] │ NULL      │ NULL              │ l  │ NULL      │
│ ["k","l"] │ NULL      │ NULL              │ l  │ NULL      │
└───────────┴───────────┴───────────────────┴────┴───────────┘
Retrieved 44 rows in 0.27s.
```

サブセットから列をネスト解除する

```sql
dsql> SELECT d3 FROM (SELECT dim1, dim2, dim3 FROM "nested_data") CROSS JOIN UNNEST(MV_TO_ARRAY(dim3)) AS example_table(d3);
┌────┐
│ d3 │
├────┤
│ a  │
│ b  │
│ c  │
│ d  │
│ g  │
│ h  │
│ i  │
│ j  │
│ m  │
│ n  │
│ k  │
│ l  │
│ k  │
│ l  │
└────┘
Retrieved 14 rows in 0.08s.
```

クエリにフィルターを含めることで、ネストを解除する行を指定できます

```sql
dsql> SELECT d3 FROM (SELECT * FROM nested_data WHERE dim2 IN ('abc')) CROSS JOIN UNNEST(MV_TO_ARRAY(dim3)) AS example_table(d3);
┌────┐
│ d3 │
├────┤
│ i  │
│ j  │
│ m  │
│ n  │
└────┘
Retrieved 4 rows in 0.17s.
```

```sql
dsql> SELECT * FROM UNNEST(ARRAY[1,2,3]) AS example_table(d1) WHERE d1 IN ('1','2');
┌────┐
│ d1 │
├────┤
│  1 │
│  2 │
└────┘
Retrieved 2 rows in 0.10s.
```

```sql
dsql> SELECT * FROM nested_data CROSS JOIN UNNEST(MV_TO_ARRAY("dim3")) AS foo(d3) WHERE d3 IN ('b', 'd') and m1 < 2;
┌──────────────────────────┬──────┬──────┬───────────┬───────────┬───────────┬─────┬─────┬────┐
│ __time                   │ dim1 │ dim2 │ dim3      │ dim4      │ dim5      │ m1  │ m2  │ d3 │
├──────────────────────────┼──────┼──────┼───────────┼───────────┼───────────┼─────┼─────┼────┤
│ 2000-01-01T00:00:00.000Z │      │ a    │ ["a","b"] │ ["x","y"] │ ["a","b"] │ 1.0 │ 1.0 │ b  │
└──────────────────────────┴──────┴──────┴───────────┴───────────┴───────────┴─────┴─────┴────┘
Retrieved 1 row in 0.16s.
```

クエリはネストを解除し,GROUP BY

```Sql
dsql> SELECT d3 FROM nested_data CROSS JOIN UNNEST(MV_TO_ARRAY(dim3)) AS example_table(d3) GROUP BY d3;
┌────┐
│ d3 │
├────┤
│ a  │
│ b  │
│ c  │
│ d  │
│ g  │
│ h  │
│ i  │
│ j  │
│ k  │
│ l  │
│ m  │
│ n  │
└────┘
Retrieved 12 rows in 0.35s.

```

ネイティブクエリは`"type": "unnest"`を指定することでネスト解除できます

```json
{
  "queryType": "scan",
  "dataSource": {
    "type": "unnest",
    "base": {
      "type": "table",
      "name": "nested_data"
    },
    "virtualColumn": {
      "type": "expression",
      "name": "unnest-dim3",
      "expression": "\"dim3\""
    }
  },
  "intervals": {
    "type": "intervals",
    "intervals": [
      "-146136543-09-08T08:23:32.096Z/146140482-04-24T15:36:27.903Z"
    ]
  },
  "limit": 100,
  "columns": ["__time", "dim1", "dim2", "dim3", "m1", "m2", "unnest-dim3"],
  "legacy": false,
  "granularity": {
    "type": "all"
  },
  "context": {
    "debug": true,
    "useCache": false
  }
}
```

unnest と group by を組み合わせる場合

```json
{
  "queryType": "groupBy",
  "dataSource": {
    "type": "unnest",
    "base": "nested_data",
    "virtualColumn": {
      "type": "expression",
      "name": "unnest-dim3",
      "expression": "\"dim3\""
    }
  },
  "intervals": ["-146136543-09-08T08:23:32.096Z/146140482-04-24T15:36:27.903Z"],
  "granularity": "all",
  "dimensions": ["unnest-dim3"],
  "limitSpec": {
    "type": "default",
    "columns": [
      {
        "dimension": "unnest-dim3",
        "direction": "descending"
      }
    ],
    "limit": 1001
  },
  "context": {
    "debug": true
  }
}
```
